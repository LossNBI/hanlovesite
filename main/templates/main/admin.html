<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>관리자 페이지 - 한사랑교회</title>
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/form.css" />
    <style>
      .admin-container {
        display: flex;
        padding: 20px;
        max-width: 1200px;
        margin: 0 auto;
      }
      .admin-nav {
        width: 250px;
        flex-shrink: 0;
        margin-right: 30px;
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
      }
      .admin-nav h2 {
        margin-top: 0;
        font-size: 1.5em;
        border-bottom: 2px solid #ccc;
        padding-bottom: 10px;
        margin-bottom: 20px;
      }
      .admin-nav ul {
        list-style: none;
        padding: 0;
      }
      .admin-nav li a {
        display: block;
        padding: 12px 15px;
        text-decoration: none;
        color: #333;
        font-weight: bold;
        border-radius: 4px;
        transition: background-color 0.2s;
      }
      .admin-nav li a:hover {
        background-color: #e9ecef;
      }
      .admin-content-section {
        flex-grow: 1;
      }
      .admin-section {
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 20px;
        display: none; /* 초기 상태는 모두 숨김 */
      }
      .admin-section.active {
        display: block; /* 클릭하면 보임 */
      }
      .admin-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
      }
      .admin-table th,
      .admin-table td {
        border: 1px solid #ddd;
        padding: 12px;
        text-align: left;
      }
      .admin-table th {
        background-color: #e9e9e9;
      }
      .btn-group {
        display: flex;
        gap: 5px;
      }
      .btn-group button {
        padding: 5px 10px;
        cursor: pointer;
        border: none;
        border-radius: 4px;
        color: white;
      }
      .btn-promote {
        background-color: #28a745;
      }
      .btn-demote {
        background-color: #dc3545;
      }
      .btn-update {
        background-color: #007bff;
      }
      .admin-form-group {
        display: flex;
        gap: 10px;
        margin-top: 10px;
      }
      .title-list-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid #eee;
      }
      .title-list-item:last-child {
        border-bottom: none;
      }
    </style>
  </head>
  <body>
    <header class="main-header">
      <div class="logo">
        <a href="/">
          <img src="/images/main.jpg" alt="로고" />
        </a>
      </div>
      <nav class="main-nav">
        <ul>
          <li class="has-submenu">
            <a href="#">교회소개</a>
            <ul class="submenu">
              <li><a href="/greetings.html">인사말</a></li>
              <li><a href="#">비전</a></li>
              <li><a href="#">섬기는 사람들</a></li>
            </ul>
          </li>
          <li class="has-submenu">
            <a href="#">교회소식</a>
            <ul class="submenu">
              <li><a href="/notice.html">공지사항</a></li>
              <li><a href="/sermon.html">주보</a></li>
              <li><a href="#">새가족</a></li>
            </ul>
          </li>
          <li class="has-submenu">
            <a href="#">부서별</a>
            <ul class="submenu">
              <li><a href="#">아동부</a></li>
              <li><a href="#">청소년부</a></li>
              <li><a href="#">청년부</a></li>
              <li><a href="#">장년부</a></li>
            </ul>
          </li>
          <li class="has-submenu">
            <a href="#">예배</a>
            <ul class="submenu">
              <li><a href="#">주일예배</a></li>
              <li><a href="#">수요예배</a></li>
              <li><a href="#">새벽기도회</a></li>
              <li><a href="#">유튜브</a></li>
            </ul>
          </li>
        </ul>
      </nav>
      <div class="user-menu">
        <a href="login.html">로그인</a>
        <a href="register.html">회원가입</a>
      </div>
    </header>

    <main class="admin-container">
      <nav class="admin-nav">
        <h2>관리자 메뉴</h2>
        <ul>
          <li>
            <a href="#" onclick="showSection('user-management')">사용자 관리</a>
          </li>
          <li>
            <a href="#" onclick="showSection('title-management')">칭호 관리</a>
          </li>
          <li><a href="#">통계 보기</a></li>
        </ul>
      </nav>

      <div class="admin-content-section">
        <div id="user-management" class="admin-section active">
          <h2>사용자 정보 수정 및 관리</h2>
          <table class="admin-table">
            <thead>
              <tr>
                <th>아이디</th>
                <th>이름</th>
                <th>이메일</th>
                <th>역할</th>
                <th>칭호</th>
                <th>관리</th>
              </tr>
            </thead>
            <tbody id="user-list"></tbody>
          </table>
        </div>

        <div id="title-management" class="admin-section">
          <h2>칭호 관리</h2>
          <form id="add-title-form" class="admin-form-group">
            <input
              type="text"
              id="new-title-input"
              placeholder="새로운 칭호 추가"
              required
              style="flex: 1"
            />
            <button type="submit" class="btn-update">추가</button>
          </form>
          <ul id="title-list"></ul>
        </div>
      </div>
    </main>

    <footer class="main-footer">
      <div class="footer-links">
        <a href="#">제안 및 문의</a> | <a href="#">이용약관</a>
      </div>
      <p class="footer-info">
        13978 경기도 안양시 박달로 413 (한일아파트상가 2,3층)
      </p>
      <p class="footer-info2">TEL : 031-444-9730 | 010-8134-4849</p>
      <p class="footer-copy">
        COPYRIGHT©2025 한사랑교회 All Rights Reserved. Designed by 손지성 청년
      </p>
    </footer>

    <script>
      let titles = [];
      const userMenu = document.querySelector(".user-menu");

      function showSection(id) {
        document.querySelectorAll(".admin-section").forEach((section) => {
          section.classList.remove("active");
        });
        document.getElementById(id).classList.add("active");
      }

      async function checkLoginStatus() {
        try {
          const response = await fetch("/api/auth/status");
          const data = await response.json();

          if (data.isLoggedIn) {
            let menuHtml = `<a href="/my-page.html" class="welcome-message">환영합니다, ${data.name}님</a><a href="#" id="logout-btn">로그아웃</a>`;

            if (data.role === "admin") {
              menuHtml = `<a href="/my-page.html" class="welcome-message">환영합니다, ${data.name}님</a><a href="/admin.html" class="admin-link">관리자 공간</a><a href="#" id="logout-btn">로그아웃</a>`;
            }

            userMenu.innerHTML = menuHtml;

            document
              .getElementById("logout-btn")
              .addEventListener("click", async (e) => {
                e.preventDefault();
                const logoutResponse = await fetch("/logout", {
                  method: "POST",
                });
                if (logoutResponse.ok) {
                  alert("로그아웃 되었습니다.");
                  window.location.reload();
                }
              });
          } else {
            userMenu.innerHTML = `<a href="/login.html">로그인</a><a href="/register.html">회원가입</a>`;
          }
        } catch (error) {
          console.error("로그인 상태 확인 오류:", error);
          userMenu.innerHTML = `<a href="/login.html">로그인</a><a href="/register.html">회원가입</a>`;
        }
      }

      async function fetchTitles() {
        try {
          const response = await fetch("/api/admin/titles");
          const data = await response.json();
          titles = data.map((t) => t.title);

          const titleListElement = document.getElementById("title-list");
          titleListElement.innerHTML = "";
          titles.forEach((title) => {
            const li = document.createElement("li");
            li.className = "title-list-item";
            li.innerHTML = `
                <span>${title}</span>
                <button class="btn-demote" onclick="deleteTitle('${title}')">삭제</button>
            `;
            titleListElement.appendChild(li);
          });
        } catch (error) {
          console.error("칭호 목록 가져오기 오류:", error);
          alert("칭호 목록을 불러오는 중 오류가 발생했습니다.");
        }
      }

      async function fetchUsers() {
        try {
          const response = await fetch("/api/admin/users");
          const users = await response.json();
          const userList = document.getElementById("user-list");
          userList.innerHTML = "";

          if (response.ok) {
            users.forEach((user) => {
              const row = document.createElement("tr");

              const titleDropdown = document.createElement("select");
              titleDropdown.onchange = (e) =>
                updateUserTitle(user._id, e.target.value);

              titles.forEach((title) => {
                const option = document.createElement("option");
                option.value = title;
                option.textContent = title;
                if (user.title === title) {
                  option.selected = true;
                }
                titleDropdown.appendChild(option);
              });

              const noTitleOption = document.createElement("option");
              noTitleOption.value = "";
              noTitleOption.textContent = "칭호 없음";
              if (!user.title) {
                noTitleOption.selected = true;
              }
              titleDropdown.prepend(noTitleOption);

              row.innerHTML = `
                <td>${user.username}</td>
                <td>${user.name}</td>
                <td>${user.email}</td>
                <td>
                  <select onchange="updateUserRole('${user._id}', this.value)">
                    <option value="user" ${
                      user.role === "user" ? "selected" : ""
                    }>일반 사용자</option>
                    <option value="admin" ${
                      user.role === "admin" ? "selected" : ""
                    }>관리자</option>
                  </select>
                </td>
                <td></td>
                <td>
                  <div class="btn-group">
                    <button class="btn-update" onclick="resetUserPassword('${
                      user._id
                    }', '${user.username}')">비밀번호 재설정</button>
                    <button class="btn-demote" onclick="deleteUser('${
                      user._id
                    }', '${user.username}')">삭제</button>
                  </div>
                </td>
              `;
              row.querySelector("td:nth-child(5)").appendChild(titleDropdown);
              userList.appendChild(row);
            });
          } else {
            alert(users.message);
            window.location.href = "/login.html";
          }
        } catch (error) {
          console.error("사용자 목록 가져오기 오류:", error);
          alert("사용자 목록을 불러오는 중 오류가 발생했습니다.");
        }
      }

      async function updateUserRole(userId, newRole) {
        const confirmUpdate = confirm(`${newRole} 역할로 변경하시겠습니까?`);
        if (!confirmUpdate) return;
        try {
          const response = await fetch("/api/admin/users/update", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ _id: userId, newRole }),
          });
          const result = await response.json();
          alert(result.message);
          if (response.ok) {
            fetchUsers();
          }
        } catch (error) {
          console.error("역할 업데이트 오류:", error);
          alert("역할 업데이트 중 오류가 발생했습니다.");
        }
      }

      async function updateUserTitle(userId, newTitle) {
        try {
          const response = await fetch("/api/admin/users/update", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ _id: userId, newTitle }),
          });
          const result = await response.json();
          alert(result.message);
          if (response.ok) {
            fetchUsers();
          }
        } catch (error) {
          console.error("칭호 업데이트 오류:", error);
          alert("칭호 업데이트 중 오류가 발생했습니다.");
        }
      }

      document
        .getElementById("add-title-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const newTitle = document.getElementById("new-title-input").value;
          if (!newTitle) return;

          try {
            const response = await fetch("/api/admin/titles/add", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ title: newTitle }),
            });
            const result = await response.json();
            alert(result.message);
            if (response.ok) {
              document.getElementById("new-title-input").value = "";
              await fetchTitles();
              fetchUsers();
            }
          } catch (error) {
            console.error("칭호 추가 오류:", error);
            alert("칭호 추가 중 오류가 발생했습니다.");
          }
        });

      async function deleteTitle(title) {
        const confirmText = prompt(
          `'${title}' 칭호를 삭제하려면 '삭제'를 입력하세요.`
        );
        if (confirmText !== "삭제") {
          alert("입력이 일치하지 않아 삭제를 취소합니다.");
          return;
        }

        try {
          const response = await fetch("/api/admin/titles/delete", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ title }),
          });
          const result = await response.json();
          alert(result.message);
          if (response.ok) {
            await fetchTitles();
            fetchUsers();
          }
        } catch (error) {
          console.error("칭호 삭제 오류:", error);
          alert("칭호 삭제 중 오류가 발생했습니다.");
        }
      }

      async function resetUserPassword(userId, username) {
        const newPassword = prompt(
          `${username} 사용자의 새로운 비밀번호를 입력하세요:`
        );
        if (!newPassword) {
          alert("비밀번호를 입력해야 합니다.");
          return;
        }

        const confirmReset = confirm(
          `정말 ${username} 사용자의 비밀번호를 재설정하시겠습니까?`
        );
        if (!confirmReset) return;

        try {
          const response = await fetch("/api/admin/users/reset-password", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ _id: userId, newPassword }),
          });
          const result = await response.json();
          alert(result.message);
          if (!response.ok) {
            console.error("비밀번호 재설정 실패:", result.message);
          }
        } catch (error) {
          console.error("비밀번호 재설정 오류:", error);
          alert("비밀번호 재설정 중 오류가 발생했습니다.");
        }
      }

      async function deleteUser(userId, username) {
        const confirmText = prompt(
          `'${username}' 사용자를 삭제하려면 '삭제'를 입력하세요.`
        );
        if (confirmText !== "삭제") {
          alert("입력이 일치하지 않아 삭제를 취소합니다.");
          return;
        }

        try {
          const response = await fetch("/api/admin/users/delete", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ _id: userId }),
          });
          const result = await response.json();
          alert(result.message);
          if (response.ok) {
            fetchUsers();
          }
        } catch (error) {
          console.error("사용자 삭제 오류:", error);
          alert("사용자 삭제 중 오류가 발생했습니다.");
        }
      }

      document.addEventListener("DOMContentLoaded", async () => {
        await checkLoginStatus();
        await fetchTitles();
        fetchUsers();
      });
    </script>
  </body>
</html>
