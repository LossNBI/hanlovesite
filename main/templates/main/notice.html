<!-- church/main/templates/main/notice.html -->

<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>교회소식 | 공지사항</title>
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://cdn.quilljs.com/1.3.6/quill.snow.css"
      rel="stylesheet"
    />
    <style>
      /* 헤더 중복 스타일 제거 후, notice.html 고유 스타일만 남김 */
      body {
        font-family: "Noto Sans KR", sans-serif;
        margin: 0;
        background-color: #f0f2f5;
      }

      .main-container,
      .post-detail-container {
        max-width: 900px;
        margin: 2rem auto;
        padding: 2rem;
        background-color: #fff;
        border-radius: 8px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      }

      .post-detail-container {
        display: none;
      }

      h1 {
        color: #4a5568;
        border-bottom: 2px solid #e2e8f0;
        padding-bottom: 0.5rem;
        margin-bottom: 1.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .post-list {
        list-style: none;
        padding: 0;
      }

      .post-item {
        padding: 1rem;
        border-bottom: 1px solid #e2e8f0;
        cursor: pointer;
      }

      .post-item:hover {
        background-color: #f7fafc;
      }

      .post-title {
        font-weight: bold;
        color: #2d3748;
        font-size: 1.1rem;
      }

      .post-meta {
        color: #a0aec0;
        font-size: 0.9rem;
        margin-top: 0.5rem;
      }

      .no-posts {
        text-align: center;
        color: #a0aec0;
        padding: 2rem;
      }

      .add-post-btn {
        background-color: #4299e1;
        color: white;
        padding: 0.75rem 1.5rem;
        border-radius: 5px;
        text-decoration: none;
        font-weight: bold;
        border: none;
        cursor: pointer;
      }

      /* Modal */
      .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 1000;
      }

      .modal-content {
        background-color: #fff;
        padding: 2rem;
        border-radius: 8px;
        width: 90%;
        max-width: 700px;
        max-height: 80vh;
        overflow-y: auto;
        position: relative;
      }

      .close-btn {
        position: absolute;
        top: 1rem;
        right: 1rem;
        font-size: 1.5rem;
        cursor: pointer;
      }

      .modal-header {
        border-bottom: 1px solid #e2e8f0;
        padding-bottom: 1rem;
        margin-bottom: 1rem;
        font-size: 1.5rem;
        font-weight: bold;
      }

      .modal-body label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: bold;
      }

      .modal-body input {
        width: 100%;
        padding: 0.5rem;
        margin-bottom: 1rem;
        border: 1px solid #ccc;
        border-radius: 4px;
      }

      /* Quill Editor 스타일링 */
      #editor-container {
        margin-bottom: 1rem;
      }

      #editor {
        height: 300px;
      }

      .modal-body .buttons {
        display: flex;
        justify-content: flex-end;
        gap: 0.5rem;
      }

      .modal-body .buttons button {
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 5px;
        cursor: pointer;
      }

      .modal-body .save-btn {
        background-color: #4299e1;
        color: white;
      }

      .modal-body .cancel-btn {
        background-color: #e2e8f0;
        color: #2d3748;
      }

      .post-detail-title {
        font-size: 1.5rem;
        font-weight: bold;
        margin-bottom: 0.5rem;
      }

      .post-detail-meta {
        color: #a0aec0;
        font-size: 0.9rem;
        margin-bottom: 1rem;
        border-bottom: 1px solid #e2e8f0;
        padding-bottom: 1rem;
      }

      .post-detail-content {
        line-height: 1.6;
        word-wrap: break-word;
        min-height: 100px;
      }

      .post-detail-actions {
        margin-top: 1.5rem;
        display: flex;
        gap: 0.5rem;
      }

      .post-detail-actions button {
        padding: 0.5rem 1rem;
        border: none;
        border-radius: 5px;
        cursor: pointer;
      }

      .edit-post-btn {
        background-color: #38b2ac;
        color: white;
      }

      .delete-post-btn {
        background-color: #e53e3e;
        color: white;
      }

      .back-to-list-btn {
        background-color: #a0aec0;
        color: #2d3748;
        padding: 0.5rem 1rem;
        border-radius: 5px;
        border: none;
        cursor: pointer;
        font-weight: bold;
      }

      /* Comments */
      .comments-section {
        margin-top: 2rem;
        border-top: 2px solid #e2e8f0;
        padding-top: 2rem;
      }

      .comments-section h3 {
        margin-bottom: 1rem;
      }

      #commentForm {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 1.5rem;
      }

      #commentForm textarea {
        flex-grow: 1;
        height: 40px;
      }

      #commentForm button {
        padding: 0.5rem 1rem;
        border: none;
        border-radius: 5px;
        background-color: #4299e1;
        color: white;
        cursor: pointer;
      }

      .comment-list {
        list-style: none;
        padding: 0;
      }

      .comment-item {
        background-color: #f7fafc;
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 1rem;
        position: relative;
      }

      .comment-item .comment-meta {
        font-size: 0.8rem;
        color: #718096;
        margin-bottom: 0.5rem;
      }

      .comment-item .comment-actions {
        position: absolute;
        top: 1rem;
        right: 1rem;
      }

      .comment-item .comment-actions button {
        background: none;
        border: none;
        cursor: pointer;
        color: #718096;
      }

      .comment-item .comment-text {
        word-wrap: break-word;
      }

      .comment-item .comment-edit-form {
        display: none;
      }

      /* Custom Alert & Confirm Modals */
      .custom-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 2000;
      }

      .custom-modal-content {
        background-color: #fff;
        padding: 2rem;
        border-radius: 8px;
        text-align: center;
        width: 80%;
        max-width: 400px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      }

      .custom-modal-content p {
        margin-bottom: 1.5rem;
        font-size: 1.1rem;
      }

      .custom-modal-content button {
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 5px;
        cursor: pointer;
      }

      .custom-modal-content .confirm-btn {
        background-color: #e53e3e;
        color: white;
        margin-left: 0.5rem;
      }

      .custom-modal-content .cancel-btn {
        background-color: #e2e8f0;
        color: #2d3748;
      }
    </style>
  </head>
  <body>
    <header class="main-header">
      <div class="logo">
        <a href="/">
          <img src="/images/main.jpg" alt="로고" />
        </a>
      </div>
      <nav class="main-nav">
        <ul>
          <li class="has-submenu">
            <a href="#">교회소개</a>
            <ul class="submenu">
              <li><a href="/greetings.html">인사말</a></li>
              <li><a href="#">비전</a></li>
              <li><a href="#">섬기는 사람들</a></li>
            </ul>
          </li>
          <li class="has-submenu">
            <a href="#">교회소식</a>
            <ul class="submenu">
              <li><a href="/notice.html">공지사항</a></li>
              <li><a href="#">주보</a></li>
              <li><a href="#">새가족</a></li>
            </ul>
          </li>
          <li class="has-submenu">
            <a href="#">부서별</a>
            <ul class="submenu">
              <li><a href="#">아동부</a></li>
              <li><a href="#">청소년부</a></li>
              <li><a href="#">청년부</a></li>
              <li><a href="#">장년부</a></li>
            </ul>
          </li>
          <li class="has-submenu">
            <a href="#">예배</a>
            <ul class="submenu">
              <li><a href="#">주일예배</a></li>
              <li><a href="#">수요예배</a></li>
              <li><a href="#">새벽기도회</a></li>
            </ul>
          </li>
        </ul>
      </nav>
      <div class="user-menu">
        <a href="login.html">로그인</a>
        <a href="register.html">회원가입</a>
      </div>
    </header>

    <main class="main-container">
      <h1>공지사항 <button class="add-post-btn">글쓰기</button></h1>

      <ul class="post-list">
        <li class="no-posts">게시글이 없습니다.</li>
      </ul>
    </main>

    <div class="post-detail-container">
      <h2 class="post-detail-title"></h2>
      <div class="post-detail-meta">
        <span class="post-detail-author"></span> |
        <span class="post-detail-date"></span>
      </div>
      <div class="post-detail-content"></div>
      <div class="post-detail-actions">
        <button class="edit-post-btn">수정</button>
        <button class="delete-post-btn">삭제</button>
        <button class="back-to-list-btn">목록으로</button>
      </div>

      <div class="comments-section">
        <h3>댓글</h3>
        <form id="commentForm">
          <textarea
            id="commentText"
            placeholder="댓글을 입력하세요..."
          ></textarea>
          <button type="submit">작성</button>
        </form>
        <ul class="comment-list">
          </ul>
      </div>
    </div>

    <div id="postModal" class="modal">
      <div class="modal-content">
        <span class="close-btn">&times;</span>
        <div class="modal-header">새 글 작성</div>
        <div class="modal-body">
          <input
            type="hidden"
            id="postId"
            name="postId"
            value=""
          />
          <label for="postTitle">제목</label>
          <input
            type="text"
            id="postTitle"
            name="postTitle"
            required
          />
          <label for="editor">내용</label>
          <div id="editor-container">
            <div id="editor"></div>
          </div>
          <div class="buttons">
            <button
              id="savePostBtn"
              class="save-btn"
            >
              저장
            </button>
            <button
              id="cancelPostBtn"
              class="cancel-btn"
            >
              취소
            </button>
          </div>
        </div>
      </div>
    </div>

    <div id="customAlertModal" class="custom-modal">
      <div class="custom-modal-content">
        <p id="alertMessage"></p>
        <button class="cancel-btn" id="alertOkBtn">확인</button>
      </div>
    </div>

    <div id="customConfirmModal" class="custom-modal">
      <div class="custom-modal-content">
        <p id="confirmMessage"></p>
        <button class="cancel-btn" id="confirmCancelBtn">취소</button>
        <button class="confirm-btn" id="confirmOkBtn">확인</button>
      </div>
    </div>

    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <script src="/js/notice.js"></script>

    <script>
      // mypage.html에서 가져온 로그인 상태 확인 스크립트
      async function checkLoginStatus() {
        const userMenu = document.querySelector(".user-menu");
        try {
          const response = await fetch("/api/auth/status");
          const data = await response.json();
          if (data.isLoggedIn) {
            let menuHtml = `<a href="/mypage.html" class="welcome-message">환영합니다, ${data.name}님</a><a href="#" id="logout-btn">로그아웃</a>`;
            if (data.role === "admin") {
              menuHtml = `<a href="/mypage.html" class="welcome-message">환영합니다, ${data.name}님</a><a href="/admin.html" class="admin-link">관리자 공간</a><a href="#" id="logout-btn">로그아웃</a>`;
            }
            userMenu.innerHTML = menuHtml;
            document
              .getElementById("logout-btn")
              .addEventListener("click", async (e) => {
                e.preventDefault();
                const logoutResponse = await fetch("/logout", {
                  method: "POST",
                });
                if (logoutResponse.ok) {
                  alert("로그아웃 되었습니다.");
                  window.location.href = "/";
                }
              });
          } else {
            userMenu.innerHTML = `<a href="/login.html">로그인</a><a href="/register.html">회원가입</a>`;
          }
        } catch (error) {
          console.error("로그인 상태 확인 오류:", error);
          userMenu.innerHTML = `<a href="/login.html">로그인</a><a href="/register.html">회원가입</a>`;
        }
      }
      document.addEventListener("DOMContentLoaded", checkLoginStatus);

      // 기존 notice.js의 코드도 동일하게 유지됩니다.
    </script>
  </body>
</html>

    <!-- 게시글 목록 페이지 -->
    <div id="postListContainer" class="main-container">
      <h1>
        <span>공지사항</span>
        <button id="addPostBtn" class="add-post-btn" style="display: none">
          글쓰기
        </button>
      </h1>
      <ul id="postList" class="post-list">
        <!-- 게시글 목록이 여기에 동적으로 추가됩니다 -->
      </ul>
      <div id="noPostsMessage" class="no-posts" style="display: none">
        아직 작성된 게시글이 없습니다.
      </div>
    </div>

    <!-- 게시글 상세 페이지 (새로 추가) -->
    <div id="postDetailsContainer" class="post-detail-container">
      <div id="postDetailsContent">
        <h2 class="post-detail-title"></h2>
        <div class="post-detail-meta"></div>
        <div class="post-detail-content"></div>
        <div class="post-detail-actions">
          <button id="editPostBtn" class="edit-post-btn" style="display: none">
            수정
          </button>
          <button
            id="deletePostBtn"
            class="delete-post-btn"
            style="display: none"
          >
            삭제
          </button>
        </div>
      </div>
      <button id="backToListBtn" class="back-to-list-btn">
        목록으로 돌아가기
      </button>

      <!-- 댓글 영역 -->
      <div class="comments-section">
        <h3>댓글</h3>
        <div id="commentFormContainer">
          <form id="commentForm">
            <textarea
              id="commentText"
              placeholder="댓글을 입력하세요..."
              required
            ></textarea>
            <button type="submit">작성</button>
          </form>
        </div>
        <ul id="commentList" class="comment-list"></ul>
      </div>
    </div>

    <!-- 글쓰기 / 수정 모달 (기존과 동일) -->
    <div id="postModal" class="modal">
      <div class="modal-content">
        <span class="close-btn">&times;</span>
        <div class="modal-header"></div>
        <form id="postForm" class="modal-body">
          <input type="hidden" id="postIdInput" />
          <label for="postTitle">제목:</label>
          <input type="text" id="postTitle" name="title" required />
          <div id="editor-container">
            <div id="editor"></div>
          </div>
          <input type="file" id="imageInput" style="display: none" />
          <div class="buttons">
            <button type="submit" class="save-btn"></button>
            <button type="button" class="cancel-btn">취소</button>
          </div>
        </form>
      </div>
    </div>

    <!-- 커스텀 alert/confirm 모달 (기존과 동일) -->
    <div id="customAlertModal" class="custom-modal">
      <div class="custom-modal-content">
        <p id="alertMessage"></p>
        <button id="alertOkBtn">확인</button>
      </div>
    </div>

    <div id="customConfirmModal" class="custom-modal">
      <div class="custom-modal-content">
        <p id="confirmMessage"></p>
        <button id="confirmCancelBtn" class="cancel-btn">취소</button>
        <button id="confirmOkBtn" class="confirm-btn">확인</button>
      </div>
    </div>

    <!-- Quill.js 스크립트 추가 -->
    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
    <script>
      const postListContainer = document.getElementById("postListContainer");
      const postDetailsContainer = document.getElementById(
        "postDetailsContainer"
      );
      const postListEl = document.getElementById("postList");
      const noPostsMessageEl = document.getElementById("noPostsMessage");
      const addPostBtn = document.getElementById("addPostBtn");
      const backToListBtn = document.getElementById("backToListBtn");

      const postModal = document.getElementById("postModal");
      const postForm = document.getElementById("postForm");
      const postTitleInput = document.getElementById("postTitle");
      const postIdInput = document.getElementById("postIdInput");
      const modalHeader = postModal.querySelector(".modal-header");
      const saveBtn = postModal.querySelector(".save-btn");

      const postDetailsContent = document.getElementById("postDetailsContent");
      const editPostBtn = document.getElementById("editPostBtn");
      const deletePostBtn = document.getElementById("deletePostBtn");
      const commentForm = document.getElementById("commentForm");
      const commentList = document.getElementById("commentList");
      let currentPostId = null;
      let authStatus = {};

      const customAlertModal = document.getElementById("customAlertModal");
      const alertMessageEl = document.getElementById("alertMessage");
      const alertOkBtn = document.getElementById("alertOkBtn");

      const customConfirmModal = document.getElementById("customConfirmModal");
      const confirmMessageEl = document.getElementById("confirmMessage");
      const confirmOkBtn = document.getElementById("confirmOkBtn");
      const confirmCancelBtn = document.getElementById("confirmCancelBtn");

      const showAlert = (message) => {
        return new Promise((resolve) => {
          alertMessageEl.textContent = message;
          customAlertModal.style.display = "flex";
          alertOkBtn.onclick = () => {
            customAlertModal.style.display = "none";
            resolve(true);
          };
        });
      };

      const showConfirm = (message) => {
        return new Promise((resolve) => {
          confirmMessageEl.textContent = message;
          customConfirmModal.style.display = "flex";
          confirmOkBtn.onclick = () => {
            customConfirmModal.style.display = "none";
            resolve(true);
          };
          confirmCancelBtn.onclick = () => {
            customConfirmModal.style.display = "none";
            resolve(false);
          };
        });
      };

      // Quill.js 에디터 설정
      const toolbarOptions = [
        [{ header: [1, 2, 3, 4, 5, 6, false] }],
        ["bold", "italic", "underline", "strike"],
        ["blockquote", "code-block"],
        [{ list: "ordered" }, { list: "bullet" }],
        [{ script: "sub" }, { script: "super" }],
        [{ indent: "-1" }, { indent: "+1" }],
        [{ direction: "rtl" }],
        [{ size: ["small", false, "large", "huge"] }],
        [{ color: [] }, { background: [] }],
        [{ font: [] }],
        [{ align: [] }],
        ["link", "image", "video"],
        ["clean"],
      ];
      const quill = new Quill("#editor", {
        modules: {
          toolbar: toolbarOptions,
        },
        theme: "snow",
      });

      const imageInput = document.getElementById("imageInput");

      quill.getModule("toolbar").addHandler("image", () => {
        imageInput.click();
      });

      imageInput.addEventListener("change", async () => {
        const file = imageInput.files[0];
        if (!file) return;

        const formData = new FormData();
        formData.append("file", file);

        try {
          const response = await fetch("/api/upload", {
            method: "POST",
            body: formData,
          });
          const result = await response.json();
          if (response.ok) {
            const range = quill.getSelection(true);
            quill.insertEmbed(range.index, "image", result.url);
          } else {
            await showAlert("파일 업로드에 실패했습니다.");
          }
        } catch (error) {
          console.error("파일 업로드 오류:", error);
          await showAlert("파일 업로드 중 오류가 발생했습니다.");
        }
      });

      // 템플릿: 시간 변환
      const timeAgo = (date) => {
        const seconds = Math.floor((new Date() - new Date(date)) / 1000);
        let interval = seconds / 31536000;
        if (interval > 1) return Math.floor(interval) + "년 전";
        interval = seconds / 2592000;
        if (interval > 1) return Math.floor(interval) + "달 전";
        interval = seconds / 86400;
        if (interval > 1) return Math.floor(interval) + "일 전";
        interval = seconds / 3600;
        if (interval > 1) return Math.floor(interval) + "시간 전";
        interval = seconds / 60;
        if (interval > 1) return Math.floor(interval) + "분 전";
        return "방금 전";
      };

      // 템플릿: 게시글 목록 렌더링
      const renderPostList = (posts) => {
        postListEl.innerHTML = "";
        if (posts.length === 0) {
          noPostsMessageEl.style.display = "block";
          return;
        }
        noPostsMessageEl.style.display = "none";
        posts.forEach((post) => {
          const li = document.createElement("li");
          li.className = "post-item";
          // 클릭 시 URL 해시 변경
          li.onclick = () => {
            window.location.hash = `#${post._id}`;
          };
          li.innerHTML = `
            <div class="post-title">${post.title}</div>
            <div class="post-meta">작성자: ${post.authorName} | ${timeAgo(
            post.createdAt
          )}</div>
          `;
          postListEl.appendChild(li);
        });
      };

      // 템플릿: 게시글 상세 렌더링
      const showPostDetails = async (postId) => {
        if (!postId) {
          // ID가 없으면 목록 페이지로 전환
          postListContainer.style.display = "block";
          postDetailsContainer.style.display = "none";
          return;
        }

        currentPostId = postId;
        try {
          const response = await fetch(`/api/posts/${postId}`);
          if (!response.ok) throw new Error("게시글을 불러오지 못했습니다.");
          const post = await response.json();

          // 게시글 내용 업데이트
          postDetailsContent.querySelector(".post-detail-title").textContent =
            post.title;
          postDetailsContent.querySelector(
            ".post-detail-meta"
          ).textContent = `작성자: ${post.authorName} | ${timeAgo(
            post.createdAt
          )} | 댓글 ${post.comments.length}개`;
          postDetailsContent.querySelector(".post-detail-content").innerHTML =
            post.content;

          // 수정/삭제 버튼 가시성 설정
          const isAuthor =
            authStatus.isLoggedIn && authStatus.name === post.authorName;
          const isAdmin = authStatus.isLoggedIn && authStatus.role === "admin";
          editPostBtn.style.display =
            isAuthor || isAdmin ? "inline-block" : "none";
          deletePostBtn.style.display =
            isAuthor || isAdmin ? "inline-block" : "none";

          // 댓글 렌더링
          renderComments(post.comments);

          // 상세 페이지 표시, 목록 페이지 숨김
          postListContainer.style.display = "none";
          postDetailsContainer.style.display = "block";
        } catch (error) {
          console.error("게시글 상세 보기 오류:", error);
          await showAlert("게시글을 불러오는 중 오류가 발생했습니다.");
          window.location.hash = ""; // 오류 발생 시 목록으로 돌아감
        }
      };

      // 템플릿: 댓글 렌더링
      const renderComments = (comments) => {
        commentList.innerHTML = "";
        if (authStatus.isLoggedIn) {
          commentForm.style.display = "flex";
        } else {
          commentForm.style.display = "none";
        }

        comments.forEach((comment) => {
          const li = document.createElement("li");
          li.className = "comment-item";
          const isAuthor =
            authStatus.isLoggedIn && authStatus.name === comment.authorName;
          const isAdmin = authStatus.isLoggedIn && authStatus.role === "admin";

          li.innerHTML = `
            <div class="comment-meta">
              <strong>${comment.authorName}</strong> | <span>${timeAgo(
            comment.createdAt
          )}</span>
            </div>
            <div class="comment-text">${comment.text}</div>
            <div class="comment-actions">
              ${
                isAuthor || isAdmin
                  ? `<button class="edit-comment-btn" data-id="${comment._id}">수정</button>`
                  : ""
              }
              ${
                isAuthor || isAdmin
                  ? `<button class="delete-comment-btn" data-id="${comment._id}">삭제</button>`
                  : ""
              }
            </div>
          `;
          commentList.appendChild(li);
        });
      };

      // 로그인 상태에 따라 헤더 메뉴를 변경하는 함수
      async function checkLoginStatus() {
        const userMenu = document.querySelector(".user-menu");
        try {
          const response = await fetch("/api/auth/status");
          const data = await response.json();
          if (data.isLoggedIn) {
            let menuHtml = `<a href="/my-page.html" class="welcome-message">환영합니다, ${data.name}님</a><a href="#" id="logout-btn">로그아웃</a>`;
            if (data.role === "admin") {
              menuHtml = `<a href="/my-page.html" class="welcome-message">환영합니다, ${data.name}님</a><a href="/admin.html" class="admin-link">관리자 공간</a><a href="#" id="logout-btn">로그아웃</a>`;
            }
            userMenu.innerHTML = menuHtml;
            document
              .getElementById("logout-btn")
              .addEventListener("click", async (e) => {
                e.preventDefault();
                const logoutResponse = await fetch("/logout", {
                  method: "POST",
                });
                if (logoutResponse.ok) {
                  alert("로그아웃 되었습니다.");
                  window.location.href = "/";
                }
              });
          } else {
            userMenu.innerHTML = `<a href="/login.html">로그인</a><a href="/register.html">회원가입</a>`;
          }
        } catch (error) {
          console.error("로그인 상태 확인 오류:", error);
          userMenu.innerHTML = `<a href="/login.html">로그인</a><a href="/register.html">회원가입</a>`;
        }
      }

      // API: 로그인 상태 확인
      const checkAuthStatus = async () => {
        try {
          const response = await fetch("/api/auth/status");
          if (response.ok) {
            const status = await response.json();
            updateUI(status);
          }
        } catch (error) {
          console.error("인증 상태 확인 오류:", error);
        }
      };

      // API: 게시글 목록 가져오기
      const fetchPosts = async () => {
        try {
          const response = await fetch("/api/posts");
          const posts = await response.json();
          renderPostList(posts);
          handleHashChange(); // 목록을 불러온 후 URL 해시를 확인하여 상세 페이지 표시
        } catch (error) {
          console.error("게시글 목록 불러오기 오류:", error);
          await showAlert("게시글을 불러오는 중 오류가 발생했습니다.");
        }
      };

      // API: 로그아웃
      const logout = async () => {
        try {
          const response = await fetch("/logout", { method: "POST" });
          const result = await response.json();
          if (response.ok) {
            window.location.href = "/";
          } else {
            await showAlert(result.message);
          }
        } catch (error) {
          console.error("로그아웃 오류:", error);
          await showAlert("로그아웃 중 오류가 발생했습니다.");
        }
      };

      // URL 해시 변경 핸들러 (새로 추가)
      const handleHashChange = () => {
        const postId = window.location.hash.slice(1); // '#' 제거
        if (postId) {
          showPostDetails(postId);
        } else {
          showPostDetails(null);
        }
      };

      // 이벤트 리스너
      addPostBtn.addEventListener("click", () => {
        postForm.reset();
        quill.root.innerHTML = "";
        postIdInput.value = "";
        modalHeader.textContent = "새 게시글 작성";
        saveBtn.textContent = "작성";
        postModal.style.display = "flex";
      });

      backToListBtn.addEventListener("click", () => {
        window.location.hash = ""; // URL 해시를 제거하여 목록으로 돌아가기
      });

      postForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const postId = postIdInput.value;
        const title = postTitleInput.value;
        const content = quill.root.innerHTML;
        const method = postId ? "PUT" : "POST";
        const url = postId ? `/api/posts/${postId}` : "/api/posts";

        try {
          const response = await fetch(url, {
            method: method,
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ title, content }),
          });
          const result = await response.json();
          if (response.ok) {
            await showAlert(result.message);
            postModal.style.display = "none";
            fetchPosts();
          } else {
            await showAlert(result.message);
          }
        } catch (error) {
          console.error("게시글 저장 오류:", error);
          await showAlert("게시글 저장 중 오류가 발생했습니다.");
        }
      });

      editPostBtn.addEventListener("click", async () => {
        try {
          const response = await fetch(`/api/posts/${currentPostId}`);
          const post = await response.json();
          postDetailsContainer.style.display = "none";
          postIdInput.value = post._id;
          postTitleInput.value = post.title;
          quill.root.innerHTML = post.content;
          modalHeader.textContent = "게시글 수정";
          saveBtn.textContent = "수정";
          postModal.style.display = "flex";
        } catch (error) {
          console.error("게시글 수정 준비 오류:", error);
        }
      });

      deletePostBtn.addEventListener("click", async () => {
        const confirmed = await showConfirm(
          "정말로 이 게시글을 삭제하시겠습니까?"
        );
        if (confirmed) {
          try {
            const response = await fetch(`/api/posts/${currentPostId}`, {
              method: "DELETE",
            });
            const result = await response.json();
            if (response.ok) {
              await showAlert(result.message);
              window.location.hash = ""; // 삭제 후 목록으로 돌아가기
            } else {
              await showAlert(result.message);
            }
          } catch (error) {
            console.error("게시글 삭제 오류:", error);
            await showAlert("게시글 삭제 중 오류가 발생했습니다.");
          }
        }
      });

      commentForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const commentText = document.getElementById("commentText").value;
        try {
          const response = await fetch(`/api/posts/${currentPostId}/comments`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ commentText }),
          });
          const result = await response.json();
          if (response.ok) {
            document.getElementById("commentText").value = "";
            showPostDetails(currentPostId);
          } else {
            await showAlert(result.message);
          }
        } catch (error) {
          console.error("댓글 작성 오류:", error);
          await showAlert("댓글 작성 중 오류가 발생했습니다.");
        }
      });

      commentList.addEventListener("click", async (e) => {
        if (e.target.classList.contains("edit-comment-btn")) {
          const commentId = e.target.dataset.id;
          const newText = await showConfirm("수정할 댓글 내용을 입력하세요.");
          if (newText) {
            try {
              const response = await fetch(
                `/api/posts/${currentPostId}/comments/${commentId}`,
                {
                  method: "PUT",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({ newText }),
                }
              );
              const result = await response.json();
              if (response.ok) {
                await showAlert(result.message);
                showPostDetails(currentPostId);
              } else {
                await showAlert(result.message);
              }
            } catch (error) {
              console.error("댓글 수정 오류:", error);
              await showAlert("댓글 수정 중 오류가 발생했습니다.");
            }
          }
        }
        if (e.target.classList.contains("delete-comment-btn")) {
          const confirmed = await showConfirm(
            "정말로 이 댓글을 삭제하시겠습니까?"
          );
          if (confirmed) {
            const commentId = e.target.dataset.id;
            try {
              const response = await fetch(
                `/api/posts/${currentPostId}/comments/${commentId}`,
                {
                  method: "DELETE",
                }
              );
              const result = await response.json();
              if (response.ok) {
                await showAlert(result.message);
                showPostDetails(currentPostId);
              } else {
                await showAlert(result.message);
              }
            } catch (error) {
              console.error("댓글 삭제 오류:", error);
              await showAlert("댓글 삭제 중 오류가 발생했습니다.");
            }
          }
        }
      });

      // 모달 닫기
      document.querySelectorAll(".close-btn, .cancel-btn").forEach((btn) => {
        btn.addEventListener("click", () => {
          postModal.style.display = "none";
        });
      });

      // 페이지 로드 시 초기화 및 해시 변경 감지
      document.addEventListener("DOMContentLoaded", () => {
        checkAuthStatus();
        fetchPosts();
      });

      // URL 해시가 변경될 때마다 페이지 상태를 업데이트
      window.addEventListener("hashchange", handleHashChange);
    </script>
  </body>
</html>
